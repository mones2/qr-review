<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Owner — Your Restaurants</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg: #070a12;
      --panel: #0f1420;
      --text: #f2f4fb;
      --muted: #aeb3c4;
      --border: rgba(255,255,255,.14);
      --accent: #22c55e;       /* neon emerald (fallback) */
      --accent-2: #16a34a;
      --neon: 0 0 22px color-mix(in srgb, var(--accent) 75%, transparent),
              0 0 48px color-mix(in srgb, var(--accent) 40%, transparent);
      --r: 18px;
      --tap: 48px;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--text);
      font: 16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 60%),
        radial-gradient(1200px 600px at 90% 110%, rgba(0, 187, 255, .08), transparent 60%),
        var(--bg);
    }

    a{ color:inherit; text-decoration:none }
    a:hover{ text-decoration:underline }

    .wrap{ max-width: 1100px; margin: 28px auto 72px; padding: 0 16px; }

    /* Top bar */
    .top{
      position: sticky; top: 0; z-index: 20;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 16px;
      backdrop-filter: blur(8px) saturate(1.2);
      background: linear-gradient(180deg, rgba(15,20,32,.88), rgba(15,20,32,.70));
      border-bottom: 1px solid var(--border);
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px;
      text-decoration:none;
    }
    .brand__dot{
      width:14px; height:14px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, color-mix(in srgb, var(--accent) 60%, #fff));
      box-shadow: var(--neon);
    }
    .brand__name{ color:#fff }

    .top__right{ display:flex; align-items:center; gap:10px }
    .user{ display:flex; align-items:center; gap:8px; color:var(--muted) }
    .hidden{ display:none !important }

    /* Hero */
    .hero h1{
      margin:.25rem 0 .4rem; font-weight:900;
      font-size: clamp(1.6rem, 1.2rem + 2vw, 2.4rem);
      letter-spacing:-.02em;
      text-shadow: var(--neon);
    }
    .hero .lede{ color:var(--muted); margin: 0 0 .8rem }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)), var(--panel);
      border:1px solid var(--border); border-radius: var(--r); padding:16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }

    /* Buttons */
    .btn{
      appearance:none; cursor:pointer; user-select:none;
      display:inline-flex; align-items:center; justify-content:center; gap:.6rem;
      min-height:var(--tap); padding:.7rem 1.1rem; border-radius:999px; font-weight:800;
      color:#06140d;
      background: linear-gradient(271deg, color-mix(in srgb, var(--accent) 70%, #fff), var(--accent-2));
      border:1px solid color-mix(in srgb, var(--accent) 55%, #ffffff33);
      box-shadow: var(--neon);
      text-decoration:none;
      transition: transform .08s ease, opacity .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ transform: translateY(-1px) }
    .btn:active{ transform: translateY(0) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; box-shadow:none }
    .btn--ghost{
      color:var(--text); background: rgba(255,255,255,.06);
      border:1px solid var(--border); box-shadow:none;
    }

    /* Status / toasts */
    .status{ color:var(--muted); margin:.4rem 0 .8rem }
    .toasts{ position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:40 }
    .toast{ padding:.6rem .8rem; border-radius:12px; background:#0f1420; border:1px solid var(--border) }
    .toast--ok{ color:#baffde; border-color: color-mix(in srgb, var(--accent) 40%, var(--border)) }
    .toast--bad{ color:#ffd3d3; border-color: #ff7a7a66 }

    /* Tenants grid */
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(3, minmax(240px, 1fr)) }
    @media (max-width:980px){ .grid{ grid-template-columns: repeat(2, 1fr) } }
    @media (max-width:620px){ .grid{ grid-template-columns: 1fr } }

    .tenant{
      position:relative; overflow:hidden;
      border-radius:16px; padding:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      cursor:pointer; text-decoration:none; color:inherit;
      transition: transform .10s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .tenant:hover{
      transform: translateY(-2px);
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      box-shadow: var(--neon);
    }
    .tenant__name{ font-weight:900; font-size: 1.1rem; margin-bottom:.15rem }
    .tenant__slug{ color:var(--muted); font-size:.95rem }

    .accent-bar{
      position:absolute; inset:auto 0 0 0; height:3px;
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 60%, #fff), var(--accent-2));
      box-shadow: var(--neon);
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .foot{ margin: 26px 0; color:var(--muted); font-size:.95rem; text-align:center }
  </style>
</head>
<body>
  <!-- Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <div class="top">
    <a class="brand" href="/owner">
      <span class="brand__dot" aria-hidden="true"></span>
      <span class="brand__name">Owner</span>
    </a>
    <div class="top__right">
      <button id="loginBtn" class="btn">Log in / Sign up</button>
      <div id="userBox" class="user hidden">
        <span id="whoami">—</span>
        <button id="logoutBtn" class="btn btn--ghost">Log out</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="hero">
      <h1>Your restaurants</h1>
      <p class="lede">Pick a restaurant to open the dashboard. If you only own one, we’ll jump there automatically.</p>
    </section>

    <section class="card">
      <div id="status" class="status">Checking your account…</div>

      <div id="grid" class="grid" aria-live="polite">
        <!-- tenant cards injected here -->
      </div>

      <div class="actions">
        <a class="btn" href="/create-tenant.html">Create a restaurant</a>
        <a class="btn btn--ghost" href="/r/sahara" target="_blank" rel="noopener">See a public page</a>
      </div>
    </section>

    <div class="foot">© <span id="year"></span> Your Company</div>
  </main>

  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ---------- helpers ---------- */
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
    const toastBox = $('#toasts');
    const toast = (m, t='ok') => {
      const el = document.createElement('div');
      el.className = `toast ${t==='ok'?'toast--ok':'toast--bad'}`;
      el.textContent = m; toastBox.appendChild(el);
      setTimeout(()=> el.remove(), 3500);
    };

    /* ---------- identity ---------- */
    let user = null;

    function initIdentity(){
      if (!window.netlifyIdentity){
        $('#status').textContent = 'Identity script failed to load.';
        return;
      }
      netlifyIdentity.on('init', u => { user = u; updateAuthUI(); bootstrap(); });
      netlifyIdentity.on('login', u => { user = u; updateAuthUI(); netlifyIdentity.close(); bootstrap(); });
      netlifyIdentity.on('logout', () => { user = null; updateAuthUI(); resetUI(); });
      netlifyIdentity.init();
    }
    function updateAuthUI(){
      const logged = !!user;
      $('#loginBtn').classList.toggle('hidden', logged);
      $('#userBox').classList.toggle('hidden', !logged);
      $('#whoami').textContent = logged ? user.email : '—';
    }
    on($('#loginBtn'), 'click', () => netlifyIdentity.open('login'));
    on($('#logoutBtn'), 'click', () => netlifyIdentity.logout());

    /* ---------- launcher logic ---------- */
    function resetUI(){
      $('#status').textContent = 'Not logged in. Please log in to see your restaurants.';
      $('#grid').innerHTML = '';
    }

    async function authedFetch(url, opts={}){
      if (!user) throw new Error('Not logged in');
      const token = await user.jwt(true);
      const res = await fetch(url, {
        ...opts,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...(opts.headers||{})
        }
      });
      return res;
    }

    async function bootstrap(){
      if (!user){ resetUI(); return; }
      $('#status').textContent = 'Loading your restaurants…';
      $('#grid').innerHTML = '';

      try{
        const res = await authedFetch('/.netlify/functions/my-tenants');
        if (res.status === 404){
          $('#status').textContent = 'This site has no "my-tenants" function yet.';
          return;
        }
        const data = await res.json();
        if (!res.ok || !data.ok){
          throw new Error(data.error || `HTTP ${res.status}`);
        }
        const list = Array.isArray(data.tenants) ? data.tenants : [];

        if (list.length === 0){
          $('#status').textContent = 'No restaurants found for your account.';
          $('#grid').innerHTML = '';
          return;
        }
        if (list.length === 1){
          const slug = list[0].slug;
          $('#status').textContent = 'Opening your dashboard…';
          // Use replace so Back doesn’t bounce here
          location.replace(`/owner/${encodeURIComponent(slug)}`);
          return;
        }

        // Multiple tenants: render a neon picker
        $('#status').textContent = 'Choose a restaurant:';
        renderGrid(list);
      }catch(e){
        $('#status').textContent = 'Could not load your restaurants.';
        toast(String(e), 'bad');
      }
    }

    function renderGrid(list){
      const grid = $('#grid');
      grid.innerHTML = '';
      list.sort((a,b)=> (a.name||a.slug).localeCompare(b.name||b.slug)).forEach(t=>{
        const card = document.createElement('a');
        card.className = 'tenant';
        card.href = `/owner/${encodeURIComponent(t.slug)}`;
        card.innerHTML = `
          <div class="tenant__name">${escapeHtml(t.name || t.slug)}</div>
          <div class="tenant__slug">/${escapeHtml(t.slug)}</div>
          <div class="accent-bar" style="--accent:${cssColor(t.brand_color || '#22c55e')};"></div>
        `;
        // per-tenant neon on hover
        card.addEventListener('mouseenter', () => document.documentElement.style.setProperty('--accent', cssColor(t.brand_color || '#22c55e')));
        grid.appendChild(card);
      });
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }
    function cssColor(x){ return /^#|rgb|hsl/i.test(String(x)) ? x : '#22c55e'; }

    /* ---------- boot ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      $('#year').textContent = new Date().getFullYear();
      initIdentity();
    });
  </script>
</body>
</html>
