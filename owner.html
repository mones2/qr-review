<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Restaurant Reviews — Owner View (Simple Login)</title>
<style>
  :root {
    --bg:#0b0d14; --surface:#111522;
    --g1:rgba(255,255,255,.045); --g2:rgba(255,255,255,.02);
    --border:rgba(255,255,255,.10); --border-2:rgba(255,255,255,.18);
    --text:#f2f4fb; --muted:#aeb3c4; --a1:#00c7ff; --a2:#3b82f6;
    --success:#8dffcc; --r:20px; --shadow:0 0 30px rgba(0,199,255,.16);
    --focus:0 0 0 4px rgba(0,199,255,.45); --tap:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font:400 18px/1.6 system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1100px 650px at 18% -12%, rgba(0,199,255,.13), transparent 60%),
      radial-gradient(1200px 700px at 82% 0%, rgba(59,130,246,.11), transparent 60%),
      var(--bg);
  }
  .wrap{max-width:1000px;margin:32px auto;padding:0 18px}
  h1{margin:0 0 .25rem;font-size:clamp(2rem,5vw,3rem);letter-spacing:-.02em;line-height:1.1}
  h2{margin:.1rem 0 .9rem;font-size:clamp(1.2rem,3.5vw,1.5rem);font-weight:500;color:var(--muted)}
  .accent{background:linear-gradient(90deg,var(--a1),var(--a2));-webkit-background-clip:text;background-clip:text;color:transparent}
  .card{background:linear-gradient(180deg,var(--g1),var(--g2)),var(--surface);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:20px;margin-top:14px}
  .row{display:flex;flex-wrap:wrap;gap:.8rem;align-items:center}
  .hidden{display:none!important}
  .muted{color:var(--muted)}
  .btn{font-weight:800;min-height:var(--tap);display:inline-flex;align-items:center;justify-content:center;gap:.6rem;padding:1rem 1.4rem;border-radius:9999px;color:#fff;text-decoration:none;border:1px solid var(--border);background:linear-gradient(271deg,#00c7ffa6,var(--a2));cursor:pointer}
  .btn--ghost{color:var(--text);background:rgba(255,255,255,.06);border:1px solid var(--border)}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  input,select{width:100%;min-height:48px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:.7rem 1rem;font:inherit}
  label{font-weight:700;display:block;margin:.4rem 0 .2rem}
  table{border-collapse:collapse;width:100%}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);text-align:left;vertical-align:top}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px;background:#1e293b;color:#cbd5e1;display:inline-block;margin:2px 4px 2px 0}
  .pill--ab{background:#3a2a1b;color:#ffd9a8}
  .stats{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin:12px 0}
  .stat{border:1px solid var(--border);border-radius:14px;padding:12px}
  .stat strong{display:block;font-size:14px;color:#cbd5e1}
  .stat div{font-size:22px;font-weight:800}
  .hr{height:1px;background:rgba(255,255,255,.12);margin:1rem 0}
  .right{margin-left:auto}
  .warning{background:#2a1f1f;border:1px solid #593131;color:#ffd4d4;border-radius:12px;padding:10px;margin-top:10px}
  .hint{font-size:12px;color:#9fb0c7}
</style>
</head>
<body>
  <main class="wrap">
    <h1>Owner Reviews <span class="accent">(Simple Login)</span></h1>
    <h2>Username is the restaurant slug (e.g. <code>sahara</code>), password is <code>123456</code>.</h2>

    <!-- Login Card -->
    <section id="loginCard" class="card" aria-live="polite">
      <div class="row" style="gap:16px">
        <div style="flex:1 1 280px">
          <label for="username">Restaurant (username)</label>
          <input id="username" placeholder="e.g. sahara" autocomplete="username" />
        </div>
        <div style="flex:1 1 220px">
          <label for="password">Password</label>
          <input id="password" type="password" value="" autocomplete="current-password" />
        </div>
        <div style="flex:0 0 auto;align-self:end">
          <button id="loginBtn" class="btn">Login</button>
        </div>
      </div>
      <div class="warning"><strong>Heads-up:</strong> this is a minimal, front-end-only gate. Anyone who views source can bypass it. For real protection use your Netlify Identity + <code>reviews-owner</code> endpoint.</div>
    </section>

    <!-- Dashboard Card -->
    <section id="dash" class="card hidden">
      <div class="row">
        <div>
          <strong>Restaurant:</strong> <span id="restLabel">—</span>
        </div>
        <div class="right row">
          <button id="reloadBtn" class="btn btn--ghost">Reload</button>
          <button id="exportBtn" class="btn">Export CSV</button>
          <button id="logoutBtn" class="btn btn--ghost">Logout</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><strong>Total</strong><div id="c-total">0</div></div>
        <div class="stat"><strong>Excellent</strong><div id="c-ex">0</div></div>
        <div class="stat"><strong>Good</strong><div id="c-good">0</div></div>
        <div class="stat"><strong>Bad</strong><div id="c-bad">0</div></div>
        <div class="stat"><strong>Abandoned</strong><div id="c-ab">0</div></div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:10px;margin:.4rem 0 1rem">
        <input id="q" placeholder="Filter text…" style="flex:1 1 280px" />
        <select id="statusMode" style="flex:0 0 180px">
          <option value="">All statuses</option>
          <option value="submitted">Submitted only</option>
          <option value="abandoned">Abandoned only</option>
        </select>
        <select id="step" style="flex:0 0 160px">
          <option value="">All steps</option>
          <option value="0">Step 0</option>
          <option value="1">Step 1</option>
          <option value="2">Step 2</option>
          <option value="3">Step 3</option>
          <option value="4">Step 4</option>
        </select>
        <select id="kind" style="flex:0 0 160px">
          <option value="">All kinds</option>
          <option value="excellent">Excellent</option>
          <option value="good">Good</option>
          <option value="bad">Bad</option>
        </select>
      </div>
      <div class="hint">Step filter applies to abandoned rows. Status defaults to “submitted” if the API doesn’t return it.</div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Date</th>
            <th>Status</th>
            <th>Step</th>
            <th>Kind</th>
            <th>Keywords</th>
            <th>Visit</th>
            <th>Parking</th>
            <th>Text</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="status" class="muted" style="margin-top:8px"></div>
    </section>
  </main>

<script>
(function(){
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const state = { slug: '', rows: [] };

  function slugify(x){
    return String(x||'').toLowerCase().trim()
      .replace(/[^a-z0-9\s-]/g,'')
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-');
  }

  function fmtDate(iso){
    try { return new Date(iso).toLocaleString(); } catch { return iso || ''; }
  }

  function normalizeRow(r){
    // Ensure the new fields exist so UI logic is stable
    const status = r.status || 'submitted';
    const step = (r.abandoned_step === null || r.abandoned_step === undefined) ? '' : r.abandoned_step;
    return { ...r, status, abandoned_step: step };
  }

  function setCounts(rows){
    const t  = rows.length;
    const ex = rows.filter(r=>r.kind==='excellent' && r.status==='submitted').length;
    const gd = rows.filter(r=>r.kind==='good' && r.status==='submitted').length;
    const bd = rows.filter(r=>r.kind==='bad' && r.status==='submitted').length;
    const ab = rows.filter(r=>r.status==='abandoned').length;
    $('#c-total').textContent = t;
    $('#c-ex').textContent    = ex;
    $('#c-good').textContent  = gd;
    $('#c-bad').textContent   = bd;
    $('#c-ab').textContent    = ab;
  }

  function renderTable(){
    const q     = $('#q').value.toLowerCase().trim();
    const kind  = $('#kind').value;
    const stat  = $('#statusMode').value; // '' | submitted | abandoned
    const stepF = $('#step').value;       // '' | 0..4 (string)

    const rows = state.rows.filter(r => {
      const okStat = !stat || r.status === stat;
      const okKind = !kind || (r.kind === kind && r.status === 'submitted');
      const okStep = !stepF || (String(r.abandoned_step) === stepF && r.status === 'abandoned');
      const text = [
        r.review_text, (r.extra||''), (r.keywords||[]).join(','), (r.visit_type||''), (r.parking||''),
        r.status, String(r.abandoned_step ?? '')
      ].join(' ').toLowerCase();
      const okQ = !q || text.includes(q);
      return okStat && okKind && okStep && okQ;
    });

    const tbody = $('#tbl tbody');
    tbody.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      const kw = (r.keywords||[]).map(k=>`<span class="pill">${k}</span>`).join(' ');
      const statPill = r.status === 'abandoned'
        ? '<span class="pill pill--ab">abandoned</span>'
        : '<span class="pill">submitted</span>';
      tr.innerHTML = `
        <td>${fmtDate(r.created_at)}</td>
        <td>${statPill}</td>
        <td>${r.status==='abandoned' ? (r.abandoned_step ?? '') : ''}</td>
        <td>${r.kind||''}</td>
        <td>${kw}</td>
        <td>${r.visit_type||''}</td>
        <td>${r.parking||''}</td>
        <td>${(r.review_text||'').replace(/\n/g,'<br>')}</td>
      `;
      tbody.appendChild(tr);
    }
    $('#status').textContent = `${rows.length} shown` + (q?` • filtered by "${q}"`: ``);
    setCounts(state.rows); // counts of all, not filtered
  }

  function toCSV(rows){
    const headers = [
      'created_at','status','abandoned_step','kind','keywords',
      'visit_type','parking','extra','review_text','posted_to_google','ai_used','started_at','exited_at'
    ];
    const esc = s => '"'+String(s??'').replace(/"/g,'""')+'"';
    const lines = [headers.join(',')];
    for(const r of rows){
      const row = [
        r.created_at,
        r.status || 'submitted',
        (r.abandoned_step ?? ''),
        r.kind,
        (r.keywords||[]).join('|'),
        r.visit_type,
        r.parking,
        r.extra,
        r.review_text,
        r.posted_to_google,
        r.ai_used,
        r.started_at || '',
        r.exited_at || ''
      ].map(esc).join(',');
      lines.push(row);
    }
    return lines.join('\n');
  }

  function download(name, text){
    const blob = new Blob([text], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = name; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  async function fetchReviews(slug){
    const tryUrls = [
      `/.netlify/functions/reviews-list?slug=${encodeURIComponent(slug)}`,
      `/.netlify/functions/reviews-list`,
    ];
    for(const url of tryUrls){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) continue;
        const data = await res.json();
        const raw = Array.isArray(data?.reviews) ? data.reviews : (Array.isArray(data) ? data : []);
        if(!Array.isArray(raw)) continue;
        const filtered = raw.filter(r => (r.tenant_slug||'').toLowerCase()===slug);
        const rows = (filtered.length ? filtered : raw).map(normalizeRow);
        return rows;
      }catch(e){ /* try next */ }
    }
    throw new Error('No reviews endpoint available.');
  }

  async function load(){
    if(!state.slug) return;
    $('#status').textContent = 'Loading…';
    try{
      const rows = await fetchReviews(state.slug);
      state.rows = rows;
      renderTable();
      $('#status').textContent = `Loaded ${rows.length} rows`;
    }catch(e){
      $('#status').textContent = 'Failed to load reviews. If production, switch this page to the secured reviews-owner endpoint.';
    }
  }

  // Events
  $('#loginBtn').onclick = () => {
    const user = slugify($('#username').value);
    const pass = $('#password').value;
    if(!user){ alert('Enter a restaurant username (slug).'); return; }
    if(pass !== '123456'){ alert('Wrong password.'); return; }
    state.slug = user;
    $('#restLabel').textContent = state.slug;
    $('#loginCard').classList.add('hidden');
    $('#dash').classList.remove('hidden');
    load();
  };

  $('#reloadBtn').onclick = load;
  $('#logoutBtn').onclick = () => {
    state.slug = '';
    state.rows = [];
    $('#tbl tbody').innerHTML = '';
    $('#q').value = '';
    $('#kind').value = '';
    $('#statusMode').value = '';
    $('#step').value = '';
    $('#dash').classList.add('hidden');
    $('#loginCard').classList.remove('hidden');
    $('#password').value = '';
  };

  $('#q').addEventListener('input', renderTable);
  $('#kind').addEventListener('change', renderTable);
  $('#statusMode').addEventListener('change', renderTable);
  $('#step').addEventListener('change', renderTable);

  $('#exportBtn').onclick = () => {
    if(!state.rows.length){ alert('Nothing to export.'); return; }
    download(`${state.slug}-reviews.csv`, toCSV(state.rows));
  };

  // Optional deep link: /owner.html?u=sahara&p=123456
  const params = new URLSearchParams(location.search);
  if(params.get('u') && params.get('p')){
    $('#username').value = params.get('u');
    $('#password').value = params.get('p');
    $('#loginBtn').click();
  }
})();
</script>
</body>
</html>
