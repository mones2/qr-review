<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Share Your Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand: #ef4444 } /* Tailwind UI red-500 */
    .brand-bg  { background-color: var(--brand) }
    .brand-txt { color: var(--brand) }
    .brand-ring{ --tw-ring-color: var(--brand) }

    .smooth { transition: all 180ms ease }
    .step-enter{opacity:0;transform:translateY(8px)}
    .step-enter-active{opacity:1;transform:translateY(0);transition:all 200ms ease}
    .step-leave{opacity:1;transform:translateY(0)}
    .step-leave-active{opacity:0;transform:translateY(-8px);transition:all 150ms ease}

    @keyframes nudge{0%,100%{transform:translateX(0)}50%{transform:translateX(6px)}}
    .btn-arrow .arrow{display:inline-block;margin-left:.5rem;animation:nudge 1200ms ease-in-out infinite}
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900">
  <!-- App header (Application UI style) -->
  <header class="sticky top-0 z-40 bg-white shadow-sm ring-1 ring-gray-900/10">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-14 items-center justify-between">
        <div class="flex items-center gap-x-2">
          <div class="h-7 w-7 rounded-md brand-bg"></div>
          <span class="text-sm font-semibold tracking-tight">Review Assistant</span>
        </div>
        <div class="hidden sm:block text-sm text-gray-500">
          Powered by Tailwind UI patterns
        </div>
      </div>
    </div>
  </header>

  <!-- Page heading -->
  <div class="bg-white shadow-sm ring-1 ring-gray-900/5">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
      <div class="sm:flex sm:items-center sm:justify-between">
        <div>
          <h1 class="text-lg font-semibold leading-7 text-gray-900 sm:truncate sm:text-xl">
            Share your experience at <span id="restName" class="brand-txt">Sahara</span>
          </h1>
          <p class="mt-1 text-sm text-gray-500">Answer a couple of quick questions or jump straight to a polished review.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <main class="mx-auto max-w-3xl px-4 py-8 sm:px-6 lg:px-8">
    <!-- Card -->
    <section class="overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-gray-900/5">
      <div class="p-6 sm:p-8 space-y-8">

        <!-- STEP 1 ‚Äî EXPERIENCE -->
        <section id="experience" aria-labelledby="exp-title">
          <h2 id="exp-title" class="text-base font-semibold text-gray-900">How was your experience today?</h2>
          <div class="mt-5 grid grid-cols-1 gap-3 sm:grid-cols-3">
            <button type="button" data-exp="Excellent"
              class="group w-full rounded-xl border border-gray-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth">
              <div class="text-2xl">ü§©</div>
              <div class="mt-1 text-base font-medium">Excellent</div>
              <p class="text-sm text-gray-500">Everything sang.</p>
            </button>

            <button type="button" data-exp="Good"
              class="group w-full rounded-xl border border-gray-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth">
              <div class="text-2xl">üôÇ</div>
              <div class="mt-1 text-base font-medium">Good</div>
              <p class="text-sm text-gray-500">Worth sharing.</p>
            </button>

            <button type="button" data-exp="Not great"
              class="group w-full rounded-xl border border-gray-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth">
              <div class="text-2xl">üòï</div>
              <div class="mt-1 text-base font-medium">Not great</div>
              <p class="text-sm text-gray-500">Tell us why.</p>
            </button>
          </div>
        </section>

        <!-- POSITIVE PATH -->
        <section id="positive" class="hidden" aria-hidden="true">
          <!-- Top row: Google + Start writing (hidden once wizard opens) -->
          <div id="topRow" class="grid grid-cols-1 items-center gap-3 sm:grid-cols-2">
            <a id="googleTopLink" target="_blank" rel="noopener noreferrer"
               class="inline-flex h-[52px] items-center justify-center rounded-lg px-4 py-3 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth disabled:opacity-40 disabled:pointer-events-none"
               aria-label="Post on Google">
              ‚≠ê <span class="ml-2" id="googleTopText">Post on Google</span>
            </a>

            <button id="revealAi" type="button"
                    class="inline-flex h-[52px] items-center justify-center rounded-lg border border-red-500 px-4 py-3 text-red-600 hover:bg-red-50 focus:outline-none focus-visible:ring-2 brand-ring smooth"
                    aria-label="Start writing">
              ‚úçÔ∏è Start writing
            </button>
          </div>

          <!-- Wizard -->
          <div id="craftWrap" class="hidden mt-2">
            <div id="wizard" class="rounded-xl border border-gray-200 p-5 sm:p-6">
              <!-- Wizard header -->
              <div class="flex items-start justify-between">
                <div>
                  <h3 class="text-base font-semibold leading-6 text-gray-900">Write your review</h3>
                  <p class="mt-1 text-sm text-gray-500">Quick questions. Skip anytime.</p>
                </div>
                <div class="text-right">
                  <div id="wizProgress" class="text-sm text-gray-500">Step 1</div>
                  <div id="wizDots" class="mt-2 flex items-center gap-1.5" aria-hidden="true"></div>
                </div>
              </div>

              <!-- Dynamic step content -->
              <div id="wizContent" class="mt-5 step-enter step-enter-active"></div>

              <!-- Wizard nav (hidden on final step) -->
              <div id="wizNav" class="mt-6 flex flex-wrap items-center justify-between gap-3">
                <div class="flex gap-3">
                  <button id="wizBack" type="button"
                    class="rounded-lg border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 smooth"
                    aria-label="Back">Back</button>
                </div>
                <div class="flex gap-3">
                  <button id="wizSkipAll" type="button"
                    class="rounded-lg border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 smooth"
                    aria-label="Skip to review">Skip to review</button>
                  <button id="wizNext" type="button"
                    class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth"
                    aria-label="Next">Next</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- NEGATIVE PATH -->
        <section id="negative" class="hidden" aria-hidden="true">
          <div id="negForm">
            <div class="text-center">
              <div class="text-4xl">üôè</div>
              <h2 class="mt-3 text-base font-semibold">Thank you for your honesty.</h2>
              <p class="mt-2 text-sm text-gray-500">A few quick questions help the team improve.</p>
            </div>

            <div class="mt-6 space-y-6">
              <div>
                <p class="text-sm font-medium text-gray-900">Did you dine in, take out, or get delivery?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-dining"></div>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">What did you get?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-meal"></div>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">How much did you spend per person?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-spend"></div>
              </div>
              <div>
                <label for="negFeedback" class="text-sm font-medium text-gray-900">Your feedback (optional)</label>
                <textarea id="negFeedback" rows="4"
                  class="mt-2 w-full rounded-lg border border-gray-300 p-3 focus:border-gray-400 focus:outline-none focus-visible:ring-2 brand-ring"
                  placeholder="Write any details you'd like the manager to know‚Ä¶"></textarea>
              </div>
              <div class="flex items-center gap-3">
                <button id="sendNegative" type="button"
                  class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth">Send</button>
                <span id="negStatus" class="text-sm text-gray-500" aria-live="polite"></span>
              </div>
            </div>
          </div>

          <div id="negDone" class="hidden py-10 text-center">
            <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-green-100 text-3xl text-green-700">‚úì</div>
            <h3 class="mt-4 text-base font-semibold">Your feedback was sent to the restaurant.</h3>
            <p class="mt-2 text-sm text-gray-500">We appreciate your time.</p>
          </div>
        </section>

      </div>
    </section>
  </main>

  <!-- aria-live region -->
  <div id="sr-live" class="sr-only" aria-live="polite"></div>

  <script>
    /* ================== Helpers & Config ================== */
    function getTenantKey(){
      const qs = new URLSearchParams(window.location.search);
      const qid = qs.get("id");
      if (qid) return String(qid).trim().toLowerCase();
      const path = window.location.pathname.replace(/^\/+/, "");
      if (path.indexOf("r/") === 0){
        const parts = path.split("/");
        if (parts[1]) return String(parts[1]).trim().toLowerCase();
      }
      return "sahara";
    }
    const DATA_URL = "/.netlify/functions/get-tenant?slug=" + encodeURIComponent(getTenantKey());
    const TEST_GROQ_KEY = ""; // leave empty in production

    const qs  = (s, r)=> (r||document).querySelector(s);
    const qsa = (s, r)=> Array.prototype.slice.call((r||document).querySelectorAll(s));
    function setBrand(hex){ document.documentElement.style.setProperty("--brand", hex || "#ef4444"); }
    function copyText(t){
      if (navigator.clipboard?.writeText) return navigator.clipboard.writeText(t);
      const ta=document.createElement("textarea"); ta.value=t; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
      return Promise.resolve();
    }
    function googleUrl(google){
      if (google?.mapsUrl) return google.mapsUrl;
      if (google?.placeId) return "https://search.google.com/local/writereview?placeid="+encodeURIComponent(google.placeId);
      return "";
    }
    function swapContent(container, newHTML, after){
      container.classList.remove('step-enter','step-enter-active');
      container.classList.add('step-leave');
      void container.offsetWidth;
      container.classList.add('step-leave-active');
      setTimeout(function(){
        container.innerHTML = newHTML;
        if (typeof after === 'function') after();
        container.classList.remove('step-leave','step-leave-active');
        container.classList.add('step-enter');
        void container.offsetWidth;
        container.classList.add('step-enter-active');
        setTimeout(()=>container.classList.remove('step-enter','step-enter-active'), 220);
      }, 150);
    }
    function typeInto(el, text, speed=12){
      if (!el) return;
      el.value = "";
      let i = 0;
      (function tick(){
        if (i <= text.length){
          el.value = text.slice(0, i++);
          setTimeout(tick, speed);
        }
      })();
    }

    /* ================== Review text helpers ================== */
    function writeShortReview(args) {
      const name = args.name || "This restaurant";
      const exp = args.experience || "Good";
      const highlight = args.highlight || "";
      const keywords = args.keywords || [];
      const details = args.details || "";

      const openersGood = ["I stopped by","I visited","I had a meal at"];
      const openersEx   = ["Dinner at","An evening at","My visit to"];
      const opener = (exp === "Excellent" ? openersEx : openersGood)[Math.floor(Math.random()*3)];

      const k = keywords.slice(0,3);
      const dishLine = k.length ? (" The " + k.join(", ") + (k.length===1?" was":" were") + " well prepared and full of flavor.") : "";
      const hlMap = {
        "Food":" The kitchen‚Äôs attention to detail showed. üçΩÔ∏è",
        "Service":" Service was attentive and well-timed. ü§ù",
        "Atmosphere":" The room felt calm and welcoming. ‚ú®",
        "Authenticity":" Flavors felt thoughtful and true to the cuisine. üåø"
      };
      const hl = hlMap[highlight] || "";
      const extra = details ? (" " + details + ".") : "";
      const closer = (exp==="Excellent") ? " Highly recommended." : " I‚Äôd happily return.";
      return opener + " " + name + " was " + exp.toLowerCase() + "." + dishLine + hl + extra + closer;
    }
    function detailsSummary(d){
      const parts=[];
      if (d.veg) parts.push("Vegetarian options: " + d.veg);
      if (d.parking) parts.push("Parking: " + d.parking);
      if (d.kids) parts.push("Kid-friendliness: " + d.kids);
      if (d.access) parts.push("Accessibility: " + d.access);
      return parts.join(" | ");
    }

    /* ================== State ================== */
    const state = {
      tenant: null,
      experience: null,
      highlight: null,
      selectedTags: new Set(),
      showAllKw: false,
      posDetails: { veg:null, parking:null, kids:null, access:null, visit:null, extra:"" },
      neg: { dining:null, meal:null, spend:null, feedback:"" },
      wizStep: 0,
      aiDraft: null
    };

    /* ================== Chips ================== */
    function chip(label, {pressed, onClick} = {}){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className =
        "inline-flex items-center gap-1.5 rounded-full bg-white px-3 py-1.5 text-sm ring-1 ring-inset ring-gray-300 " +
        "hover:bg-gray-50 focus:outline-none focus-visible:ring-2 smooth";
      if (pressed){
        btn.classList.add("text-white"); btn.classList.add("brand-bg"); btn.classList.add("ring-transparent");
      } else {
        btn.classList.add("text-gray-700");
      }
      btn.setAttribute("aria-pressed", pressed ? "true" : "false");
      btn.textContent = label;
      btn.addEventListener("click", onClick || (()=>{}));
      return btn;
    }
    function chipGroup(sel, options, multi, getter, setter){
      const wrap=qs(sel); if (!wrap) return; wrap.innerHTML="";
      const current = getter();
      const selSet = new Set(Array.isArray(current) ? current : (current ? [current] : []));
      options.forEach(opt=>{
        const pressed = selSet.has(opt);
        wrap.appendChild(chip(opt, {pressed, onClick: ()=>{
          const on = selSet.has(opt);
          if (multi){ if (on) selSet.delete(opt); else selSet.add(opt); setter(Array.from(selSet)); }
          else { selSet.clear(); selSet.add(opt); setter(opt); }
          chipGroup(sel, options, multi, getter, setter);
        }}));
      });
    }

    /* ================== Wizard ================== */
    const WIZ_IDS = ["kw","visit","details","review"]; // compact set, final = review
    function renderDots(){
      const dots = qs("#wizDots"); if (!dots) return; dots.innerHTML="";
      for (let i=0;i<WIZ_IDS.length;i++){
        const d=document.createElement("div");
        d.className="h-1.5 w-4 rounded-full smooth " + (i === state.wizStep ? "bg-red-500" : (i < state.wizStep ? "bg-red-200" : "bg-gray-200"));
        dots.appendChild(d);
      }
    }
    function buildPayload(){
      const details = state.posDetails.extra ? state.posDetails.extra : detailsSummary(state.posDetails);
      return {
        restaurant: state.tenant?.name || "This restaurant",
        experience: state.experience || "Good",
        highlight: state.highlight || "Food",
        keywords: Array.from(state.selectedTags),
        extra: details
      };
    }
    function callGroqDirect(payload){
      if (!TEST_GROQ_KEY) return Promise.reject(new Error("TEST_GROQ_KEY is empty"));
      const system = "You write polished restaurant reviews. One paragraph, ~25‚Äì35 words, warm concise tone, 1 tasteful emoji. Mention the restaurant by name. No headings.";
      const user =
        "Restaurant: " + (payload.restaurant||"Unknown") + "\n" +
        "Experience: " + (payload.experience||"Good") + "\n" +
        "Highlight: " + (payload.highlight||"Food") + "\n" +
        "Keywords: " + ((payload.keywords||[]).slice(0,3).join(', ') || '‚Äî') + "\n" +
        "Optional details: " + (payload.extra||"‚Äî") + "\n\n" +
        "Write a single paragraph suitable to paste into Google.";
      return fetch("https://api.groq.com/openai/v1/chat/completions", {
        method:"POST",
        headers:{ "Authorization":"Bearer " + TEST_GROQ_KEY, "Content-Type":"application/json" },
        body: JSON.stringify({
          model: "meta-llama/llama-4-scout-17b-16e-instruct",
          temperature: 0.65,
          max_tokens: 160,
          messages: [{role:"system",content:system},{role:"user",content:user}]
        })
      }).then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error("Groq "+r.status+": "+t)}); return r.json(); })
        .then(d=> (d?.choices?.[0]?.message?.content || "").trim());
    }
    function generateReview(){
      const body = buildPayload();
      const fallbackText = writeShortReview({name:body.restaurant,experience:body.experience,highlight:body.highlight,keywords:body.keywords,details:body.extra});
      const tryAI = () => {
        if (TEST_GROQ_KEY) return callGroqDirect(body);
        return fetch("/.netlify/functions/review-ai", {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body), cache:"no-store"
        }).then(r=>{ if(!r.ok) throw new Error("fn"); return r.json(); })
          .then(j=> (j && j.text ? String(j.text).trim() : "" ));
      };
      return Promise.race([ tryAI().catch(()=>fallbackText), new Promise(res=> setTimeout(()=>res(fallbackText), 2200)) ]);
    }
    function prefetchAI(){ state.aiDraft = null; generateReview().then(t=>{ state.aiDraft=t; }).catch(()=>{}); }

    function renderWizardStep(){
      const id = WIZ_IDS[state.wizStep];
      const total = WIZ_IDS.length;
      qs("#wizProgress").textContent = "Step " + (state.wizStep+1) + " of " + total;
      renderDots();

      const c = qs("#wizContent");
      const nav = qs("#wizNav");
      const back = qs("#wizBack");
      const next = qs("#wizNext");
      const skipAll = qs("#wizSkipAll");

      // Hide nav entirely on the final step (Step 7 per your requirement)
      if (id === "review") nav.classList.add("hidden"); else nav.classList.remove("hidden");
      back.disabled = (state.wizStep === 0);

      if (id === "kw"){
        const html =
          '<div class="space-y-2">'+
            '<div class="flex items-center justify-between">'+
              '<p class="text-sm font-medium text-gray-900">Pick keywords</p>'+
              '<button id="kwToggle" type="button" class="rounded-md px-2 py-1 text-sm text-gray-600 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 brand-ring">See more</button>'+
            '</div>'+
            '<div id="kwWrap" class="mt-1 flex flex-wrap gap-2"></div>'+
          '</div>';
        swapContent(c, html, ()=>{
          renderKeywords();
          qs("#kwToggle")?.addEventListener("click", ()=>{ state.showAllKw=!state.showAllKw; renderKeywords(); });
        });
      }
      else if (id === "visit"){
        const html =
          '<div class="space-y-6">'+
            '<div>'+
              '<p class="text-sm font-medium text-gray-900 mb-2">Visit type</p>'+
              '<div id="visitType" class="flex flex-wrap gap-2"></div>'+
            '</div>'+
            '<div>'+
              '<p class="text-sm font-medium text-gray-900 mb-2">Parking</p>'+
              '<div id="visitParking" class="flex flex-wrap gap-2"></div>'+
            '</div>'+
          '</div>';
        swapContent(c, html, ()=>{
          chipGroup("#visitType", ["Dine-in","Takeout","Delivery"], false,
            ()=>state.posDetails.visit, v=>state.posDetails.visit=v);
          chipGroup("#visitParking", ["Street","Lot","Valet","None / not sure"], false,
            ()=>state.posDetails.parking, v=>state.posDetails.parking=v);
        });
      }
      else if (id === "details"){
        const html =
          '<div>'+
            '<label for="extraDetails" class="text-sm font-medium text-gray-900">More details (optional)</label>'+
            '<textarea id="extraDetails" rows="4" class="mt-2 w-full rounded-lg border border-gray-300 p-3 focus:border-gray-400 focus:outline-none focus-visible:ring-2 brand-ring" placeholder="Anything else that would help someone deciding to visit?"></textarea>'+
          '</div>';
        swapContent(c, html, ()=>{
          const el=qs("#extraDetails");
          el.value = state.posDetails.extra || "";
          el.addEventListener("input", ()=>{ state.posDetails.extra = el.value; });
          prefetchAI();
        });
      }
      else if (id === "review"){
        const html =
          '<div>'+
            '<label for="reviewText" class="text-sm font-medium text-gray-900">Your review</label>'+
            '<textarea id="reviewText" rows="5" class="mt-2 w-full rounded-lg border border-gray-300 p-4 text-[15px] leading-6 focus:border-gray-400 focus:outline-none focus-visible:ring-2 brand-ring" placeholder=""></textarea>'+
            '<div class="mt-4 flex flex-wrap items-center justify-center gap-3 sm:justify-start">'+
              '<button id="aiBtn" type="button" class="rounded-lg border border-red-500 px-4 py-2 text-red-600 hover:bg-red-50 focus:outline-none focus-visible:ring-2 brand-ring">Refine wording</button>'+
              '<button id="copyBtn" type="button" disabled class="rounded-lg bg-gray-800 px-4 py-2 text-white disabled:pointer-events-none disabled:opacity-40"> <span class="btn-label">Copy</span></button>'+
            '</div>'+
            '<div class="mt-6 flex justify-center">'+
              '<a id="googleFinal" target="_blank" rel="noopener noreferrer" class="btn-arrow inline-flex h-[48px] min-w-[220px] items-center justify-center rounded-lg px-5 py-3 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring">'+
                '<span>Post on Google</span><span class="arrow">‚Üí</span>'+
              '</a>'+
            '</div>'+
          '</div>';
        swapContent(c, html, ()=>{
          const ta = qs("#reviewText");
          const enableCopy = ()=> qs("#copyBtn")?.removeAttribute("disabled");
          const startTyping = (text)=> typeInto(ta, text, 12);

          if (state.aiDraft) { startTyping(state.aiDraft); enableCopy(); }
          else generateReview().then(t=>{ startTyping(t); enableCopy(); }).catch(()=>{
            startTyping(writeShortReview(buildPayload())); enableCopy();
          });

          qs("#aiBtn").addEventListener("click", ()=>{
            generateReview().then(txt => { startTyping(txt || ta.value); enableCopy(); }).catch(()=>{});
          });

          attachCopyBehavior();

          const gURL = googleUrl(state.tenant.google || null);
          const final = qs("#googleFinal");
          if (gURL) final.href = gURL; else final.removeAttribute("href");
        });
      }

      // Rebind nav each time
      back.onclick = ()=>{ if (state.wizStep > 0){ state.wizStep--; renderWizardStep(); } };
      next.onclick = ()=>{ if (state.wizStep < WIZ_IDS.length-1){ state.wizStep++; renderWizardStep(); } };
      skipAll.onclick = ()=>{ state.wizStep = WIZ_IDS.indexOf("review"); renderWizardStep(); };
    }

    function renderKeywords(){
      const wrap = qs("#kwWrap"); if (!wrap) return;
      wrap.innerHTML = "";

      const listRaw = state.tenant && state.tenant.keywords;
      const list = Array.isArray(listRaw) ? listRaw : [];

      const toggle = qs("#kwToggle");
      if (!list.length) {
        if (toggle) toggle.classList.add("hidden");
        const emptyNote = document.createElement("p");
        emptyNote.className = "text-sm text-gray-500";
        emptyNote.textContent = "No keywords found for this restaurant.";
        wrap.appendChild(emptyNote);
        return;
      }

      const max = state.showAllKw ? list.length : Math.min(16, list.length);
      for (let i = 0; i < max; i++) {
        const k = list[i];
        const pressed = state.selectedTags.has(k);
        wrap.appendChild(chip(k, {pressed, onClick: ()=>{
          const on = state.selectedTags.has(k);
          if (on) state.selectedTags.delete(k); else state.selectedTags.add(k);
          renderKeywords();
        }}));
      }

      if (toggle) {
        if (list.length <= 16) toggle.classList.add("hidden");
        else { toggle.classList.remove("hidden"); toggle.textContent = state.showAllKw ? "See fewer" : "See more"; }
      }
    }

    function attachCopyBehavior(){
      const btn=qs("#copyBtn"); if (!btn) return;
      const label=btn.querySelector(".btn-label") || btn;
      const original=label.textContent;
      btn.onclick = ()=>{
        const txt = (qs("#reviewText")?.value || "").trim(); if (!txt) return;
        copyText(txt).then(()=>{
          label.textContent="Copied";
          qs("#sr-live").textContent="Copied to clipboard";
          setTimeout(()=>{ label.textContent=original; }, 1400);
        });
      };
    }

    /* ================== Negative path ================== */
    function renderNegative(){
      chipGroup("#q-dining", ["Dine in","Take out","Delivery"], false, ()=>state.neg.dining, v=>state.neg.dining=v);
      chipGroup("#q-meal",   ["Breakfast","Brunch","Lunch","Dinner","Other"], false, ()=>state.neg.meal, v=>state.neg.meal=v);
      chipGroup("#q-spend",  ["$1‚Äì10","$10‚Äì20","$20‚Äì30","$30‚Äì50","$50‚Äì100","$100+"], false, ()=>state.neg.spend, v=>state.neg.spend=v);
      const t=qs("#negFeedback"); if (t){ t.addEventListener("input", ()=> state.neg.feedback = t.value); }
      qs("#sendNegative")?.addEventListener("click", sendNegative, { once:true });
    }
    function sendNegative(){
      const btn=qs("#sendNegative"); const status=qs("#negStatus");
      btn.disabled=true; status.textContent="Sending‚Ä¶";
      const payload = {
        tenantId: state.tenant.slug,
        restaurantName: state.tenant.name,
        timestampISO: new Date().toISOString(),
        selection:{ experience:"Not great" },
        answers: state.neg,
        userAgent: navigator.userAgent
      };
      fetch("/.netlify/functions/feedback", {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload), keepalive:true
      }).catch(()=>{});
      status.textContent="";
      const form=qs("#negForm"); const done=qs("#negDone");
      form.classList.add("opacity-0","translate-y-2");
      setTimeout(()=>{ form.classList.add("hidden"); done.classList.remove("hidden"); }, 180);
    }

    /* ================== Flow ================== */
    function setExperience(xp){
      state.experience = xp;
      if (xp==="Not great"){
        qs("#experience").classList.add("hidden");
        qs("#negative").classList.remove("hidden"); qs("#negative").setAttribute("aria-hidden","false");
        renderNegative();
      } else {
        qs("#experience").classList.add("hidden");
        qs("#positive").classList.remove("hidden"); qs("#positive").setAttribute("aria-hidden","false");
      }
    }

    /* ================== Defaults & Init ================== */
    const DEFAULT_TENANT = {
      slug: "sahara",
      name: "Sahara",
      brand: { primary: "#ef4444" },
      google: { mapsUrl: "https://www.google.com/maps/place/Sahara+Restaurant/" },
      keywords: ["shawarma","hummus","grape leaves","kabob","baklava","tabouleh","falafel","pita","saj","knafeh","chicken kebab","roasted eggplant","lamb chops"]
    };

    function renderNotFound(slug){
      setBrand("#6b7280");
      qs("#restName").textContent = slug ? `Not found: ${slug}` : "Not found";
      qs("#experience")?.classList.add("hidden");
      const holder = document.createElement("div");
      holder.className = "px-6 pb-8";
      holder.innerHTML = `<p class="text-gray-600">We couldn‚Äôt find that restaurant. Double-check the link (e.g. <code>/r/sahara</code>) or ask the owner to set it up.</p>`;
      document.querySelector("main section")?.appendChild(holder);
    }

    function init(){
      const slug = getTenantKey();
      fetch(DATA_URL, { cache: "no-store" })
        .then(res => { if (res.status === 404) return { notFound: true }; if (!res.ok) throw new Error("fetch failed"); return res.json(); })
        .then(json => {
          if (json && json.notFound) { renderNotFound(slug); return; }
          const cfg = (json && json.tenant) ? json.tenant : null;
          const data = cfg || DEFAULT_TENANT;

          state.tenant = data;
          setBrand(data.brand?.primary || "#ef4444");
          qs("#restName").textContent = data.name || "Your Restaurant";

          const gURL = googleUrl(data.google || null);
          const glTop = qs("#googleTopLink"); const glTxt = qs("#googleTopText");
          if (gURL) { glTop.href = gURL; glTxt.textContent = "Post on Google"; }
          else { glTop.removeAttribute("href"); glTop.setAttribute("aria-disabled","true"); glTxt.textContent="Google link not set"; }

          qsa("[data-exp]").forEach(b=> b.addEventListener("click", ()=> setExperience(b.getAttribute("data-exp")) ));

          const reveal = qs("#revealAi");
          if (reveal) reveal.addEventListener("click", ()=>{
            qs("#topRow").classList.add("hidden");
            qs("#craftWrap").classList.remove("hidden");
            state.wizStep = 0;
            state.selectedTags.clear();
            state.highlight = null;
            state.posDetails = { veg:null, parking:null, kids:null, access:null, visit:null, extra:"" };
            state.aiDraft = null;
            renderWizardStep();
          });

          // Nav handlers (bind once for first render; renderWizardStep will rebind as needed)
          qs("#wizBack").onclick = ()=>{};
          qs("#wizNext").onclick = ()=>{};
          qs("#wizSkipAll").onclick = ()=>{};
        })
        .catch(() => {
          const data = DEFAULT_TENANT;
          state.tenant = data;
          setBrand(data.brand?.primary || "#ef4444");
          qs("#restName").textContent = data.name || "Your Restaurant";
          const gURL = googleUrl(data.google || null);
          const glTop = qs("#googleTopLink");
          if (gURL) glTop.href = gURL; else glTop.removeAttribute("href");

          qsa("[data-exp]").forEach(b=> b.addEventListener("click", ()=> setExperience(b.getAttribute("data-exp")) ));
          const reveal = qs("#revealAi");
          if (reveal) reveal.addEventListener("click", ()=>{
            qs("#topRow").classList.add("hidden");
            qs("#craftWrap").classList.remove("hidden");
            state.wizStep = 0;
            state.selectedTags.clear();
            state.highlight = null;
            state.posDetails = { veg:null, parking:null, kids:null, access:null, visit:null, extra:"" };
            state.aiDraft = null;
            renderWizardStep();
          });
        });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
