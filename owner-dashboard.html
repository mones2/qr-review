<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Owner — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#070a12; --panel:#0f1420; --text:#f2f4fb; --muted:#aeb3c4; --border:rgba(255,255,255,.14);
      --accent:#22c55e; --accent-2:#16a34a;
      --neon:0 0 22px color-mix(in srgb, var(--accent) 75%, transparent), 0 0 48px color-mix(in srgb, var(--accent) 40%, transparent);
      --r:18px; --tap:48px; --shadow:0 10px 40px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 60%),
        radial-gradient(1200px 600px at 90% 110%, rgba(0,187,255,.08), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    a:hover{text-decoration:underline}
    .hidden{display:none!important}

    /* Top bar */
    .top{
      position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 16px;background:linear-gradient(180deg,rgba(15,20,32,.88),rgba(15,20,32,.70));
      border-bottom:1px solid var(--border);backdrop-filter:blur(8px) saturate(1.2);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
    .brand__dot{width:14px;height:14px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#fff,color-mix(in srgb,var(--accent) 60%,#fff));
      box-shadow:var(--neon)}
    .brand__name{color:#fff}
    .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{padding:.55rem .85rem;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--muted)}
    .tab--active{color:#06140d;background:linear-gradient(271deg,color-mix(in srgb,var(--accent) 55%,#fff),var(--accent-2));border-color:color-mix(in srgb,var(--accent) 55%, #ffffff33);box-shadow:var(--neon)}
    .top__right{display:flex;align-items:center;gap:10px}
    .user{display:flex;align-items:center;gap:8px;color:var(--muted)}

    /* Shell */
    .wrap{max-width:1200px;margin:28px auto 90px;padding:0 16px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02)),var(--panel);
      border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--shadow)
    }
    .hero{display:flex;gap:16px;align-items:stretch;flex-wrap:wrap}
    .hero__meta{flex:1 1 320px}
    .hero__meta h1{margin:.2rem 0 .25rem;font-weight:900;letter-spacing:-.02em;font-size:clamp(1.6rem,1.2rem + 1.5vw,2.2rem);text-shadow:var(--neon)}
    .muted{color:var(--muted)}
    .qr{display:flex;gap:14px;align-items:center;flex:1 1 380px;min-width:300px}
    .qrBox{width:180px;height:180px;border-radius:16px;display:grid;place-items:center;background:rgba(255,255,255,.06);border:1px solid var(--border)}
    .qrActions{display:flex;flex-direction:column;gap:8px;flex:1}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;min-width:160px}
    label{font-weight:700}
    .input,.select{
      width:100%;min-height:44px;border-radius:12px;background:#0f1420;color:var(--text);
      border:1px solid var(--border);padding:.6rem .75rem;outline:0
    }

    .btn{
      appearance:none;cursor:pointer;user-select:none;display:inline-flex;align-items:center;justify-content:center;gap:.6rem;
      min-height:var(--tap);padding:.7rem 1.1rem;border-radius:999px;font-weight:800;color:#06140d;
      background:linear-gradient(271deg,color-mix(in srgb,var(--accent) 70%,#fff),var(--accent-2));
      border:1px solid color-mix(in srgb,var(--accent) 55%,#ffffff33);box-shadow:var(--neon);
      text-decoration:none;transition:transform .08s ease,opacity .15s ease,box-shadow .15s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
    .btn--ghost{color:var(--text);background:rgba(255,255,255,.06);border:1px solid var(--border);box-shadow:none}

    .status{color:var(--muted);margin:.4rem 0 .8rem}
    .toasts{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:40}
    .toast{padding:.6rem .8rem;border-radius:12px;background:#0f1420;border:1px solid var(--border)}
    .toast--ok{color:#baffde;border-color:color-mix(in srgb,var(--accent) 40%,var(--border))}
    .toast--bad{color:#ffd3d3;border-color:#ff7a7a66}

    /* Filters */
    .filters{display:grid;gap:12px}
    .filters__row{display:flex;gap:12px;flex-wrap:wrap}
    .switch{display:flex;align-items:center;gap:.6rem;color:var(--muted)}

    /* KPIs */
    .kpis{display:grid;gap:12px;margin:12px 0;grid-template-columns:repeat(5,minmax(140px,1fr))}
    @media (max-width:1000px){.kpis{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{display:flex;flex-direction:column;gap:4px}
    .kpi__label{color:var(--muted);font-weight:700}
    .kpi__value{font-weight:900;font-size:clamp(1.4rem,1.1rem + 1vw,1.9rem)}

    /* Charts */
    .charts{display:grid;gap:12px;margin:12px 0;grid-template-columns:2fr 1fr}
    @media (max-width:1000px){.charts{grid-template-columns:1fr}}
    .chart{padding:0}
    .chart__title{padding:14px 16px;border-bottom:1px solid var(--border)}
    .chart__stage{padding:12px;min-height:200px}

    /* Keywords chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:inline-flex;align-items:center;gap:6px;cursor:pointer;padding:.45rem .75rem;border-radius:999px;line-height:1;
      color:var(--text);background:rgba(255,255,255,.06);border:1px solid var(--border)
    }
    .chip[aria-pressed="true"]{color:#06140d;background:linear-gradient(271deg,color-mix(in srgb,var(--accent) 55%,#fff),var(--accent-2));border-color:color-mix(in srgb,var(--accent) 55%,#ffffff33);box-shadow:var(--neon)}

    /* Table */
    .tabs{padding:0}
    .tabs__nav{display:flex;gap:6px;padding:6px;border-bottom:1px solid var(--border);position:sticky;top:calc(56px + 1px);background:linear-gradient(180deg,rgba(15,20,32,.95),rgba(15,20,32,.85));z-index:2}
    .tabs .tab{border-radius:12px;padding:.55rem .9rem;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--muted)}
    .tabs .tab--active{color:#06140d;background:linear-gradient(271deg,color-mix(in srgb,var(--accent) 55%,#fff),var(--accent-2));border-color:color-mix(in srgb,var(--accent) 55%,#ffffff33)}
    .tab-panel{padding:10px 12px}
    .table-wrap{overflow:auto}
    table.table{
      width:100%;border-collapse:separate;border-spacing:0;font-size:.95rem;border:1px solid var(--border);border-radius:14px;overflow:hidden
    }
    .table thead th{
      position:sticky;top:0;z-index:1;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      text-align:left;padding:10px 12px;border-bottom:1px solid var(--border);color:#dfe3f2;font-weight:800
    }
    .table tbody td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    .table tbody tr:nth-child(2n){background:rgba(255,255,255,.02)}
    .table__footer{display:flex;justify-content:center;padding:10px}

    .foot{margin:26px 0;color:var(--muted);font-size:.95rem;text-align:center}

    @media (max-width:860px){
      .nav{overflow:auto hidden;white-space:nowrap;mask:linear-gradient(90deg,#000 92%,transparent)}
      .qr{flex-direction:column;align-items:flex-start}
    }

    @media (prefers-reduced-motion: reduce){
      .btn{transition:none}
    }
  </style>
</head>
<body>
  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" defer></script>

  <div class="top">
    <a class="brand" href="#" aria-label="Owner dashboard home">
      <span class="brand__dot" aria-hidden="true"></span>
      <span class="brand__name">Owner</span>
    </a>
    <nav class="nav" aria-label="Primary">
      <a id="tabDash" class="tab tab--active" href="#" aria-current="page">Dashboard</a>
      <a id="tabFeedback" class="tab hidden" href="#">Quick feedback</a>
      <a id="tabSettings" class="tab" href="#">Settings</a>
      <a id="tabQR" class="tab" href="#">QR</a>
    </nav>
    <div class="top__right">
      <button id="loginBtn" class="btn">Log in / Sign up</button>
      <div id="userBox" class="user hidden" aria-live="polite">
        <span id="whoami">—</span>
        <button id="logoutBtn" class="btn btn--ghost">Log out</button>
      </div>
    </div>
  </div>

  <main class="wrap" id="main" tabindex="-1">
    <!-- Login prompt (shown if logged out) -->
    <section id="loginCard" class="card hidden" aria-labelledby="loginTitle">
      <div class="row">
        <div class="field">
          <h2 id="loginTitle" style="margin:0">Please log in</h2>
          <div class="status">Log in to view your dashboard.</div>
          <div class="row">
            <button id="openLogin" class="btn">Log in / Sign up</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Hero / header -->
    <section id="hero" class="hero card hidden" aria-live="polite">
      <div class="hero__meta">
        <h1 id="title">—</h1>
        <div id="tzNote" class="muted">All times in —</div>
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label for="publicLink">Public review link</label>
            <input id="publicLink" class="input" type="text" readonly />
          </div>
          <div class="field" style="align-self:flex-end">
            <button id="copyLink" class="btn btn--ghost" type="button">Copy</button>
            <a id="openPublic" class="btn btn--ghost" target="_blank" rel="noopener">Open</a>
          </div>
        </div>
      </div>
      <div class="qr">
        <div class="qrBox"><canvas id="qrCanvas" width="180" height="180" aria-label="QR for public page"></canvas></div>
        <div class="qrActions">
          <button id="printQR" class="btn btn--ghost" type="button">Print</button>
          <button id="downloadQR" class="btn" type="button">Download PNG</button>
          <div class="muted">/r/<span id="slugShow">—</span></div>
        </div>
      </div>
    </section>

    <!-- Filters -->
    <section id="filters" class="card hidden" aria-label="Filters">
      <div class="filters__row">
        <div class="field">
          <label for="dateRange">Date range</label>
          <select id="dateRange" class="select">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="field">
          <label for="kindFilter">Kind</label>
          <select id="kindFilter" class="select">
            <option value="all" selected>All</option>
            <option value="excellent">Excellent</option>
            <option value="good">Good</option>
            <option value="bad">Not great</option>
          </select>
        </div>
        <div class="field">
          <label for="postedFilter">Posted to Google</label>
          <select id="postedFilter" class="select">
            <option value="all" selected>All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="field">
          <label for="aiFilter">AI used</label>
          <select id="aiFilter" class="select">
            <option value="all" selected>All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="field">
          <label for="visitFilter">Visit type</label>
          <select id="visitFilter" class="select">
            <option value="all" selected>All</option>
            <option value="Dine-in">Dine-in</option>
            <option value="Takeout">Takeout</option>
            <option value="Delivery">Delivery</option>
          </select>
        </div>
        <div class="field">
          <label for="parkingFilter">Parking</label>
          <select id="parkingFilter" class="select">
            <option value="all" selected>All</option>
            <option value="Street">Street</option>
            <option value="Lot">Lot</option>
            <option value="Valet">Valet</option>
            <option value="None / not sure">None / not sure</option>
          </select>
        </div>
        <div class="field" style="flex:1 1 260px">
          <label for="searchBox">Search</label>
          <input id="searchBox" class="input" type="search" placeholder="Text, keyword…" />
        </div>
        <div class="field" style="align-self:flex-end">
          <button id="exportCsv" class="btn btn--ghost">Export CSV</button>
        </div>
      </div>

      <div class="filters__row">
        <label class="switch">
          <input id="tzToggle" type="checkbox" />
          <span>Use my timezone</span>
        </label>
      </div>
    </section>

    <!-- KPIs -->
    <section id="kpis" class="kpis hidden" aria-label="KPIs">
      <div class="kpi card"><div class="kpi__label">Total</div><div id="kpiTotal" class="kpi__value">0</div></div>
      <div class="kpi card"><div class="kpi__label">Excellent</div><div id="kpiExc" class="kpi__value">0</div></div>
      <div class="kpi card"><div class="kpi__label">Good</div><div id="kpiGood" class="kpi__value">0</div></div>
      <div class="kpi card"><div class="kpi__label">Not great</div><div id="kpiBad" class="kpi__value">0</div></div>
      <div class="kpi card"><div class="kpi__label">% posted</div><div id="kpiPosted" class="kpi__value">0%</div></div>
    </section>

    <!-- Charts -->
    <section id="charts" class="charts hidden" aria-label="Charts">
      <div class="chart card">
        <div class="chart__title">Reviews per day</div>
        <div id="chartTrend" class="chart__stage" role="img" aria-label="Reviews per day"></div>
      </div>
      <div class="chart card">
        <div class="chart__title">By kind</div>
        <div id="chartKind" class="chart__stage" role="img" aria-label="Reviews by kind"></div>
      </div>
    </section>

    <!-- Keywords -->
    <section id="keywordsCard" class="card hidden" aria-labelledby="kwTitle">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 id="kwTitle" style="margin:0">Top keywords</h3>
        <button id="keywordsReset" class="btn btn--ghost">Reset selection</button>
      </div>
      <div id="keywordsCloud" class="chips" style="margin-top:8px"></div>
    </section>

    <!-- Tables -->
    <section id="tables" class="tabs card hidden" aria-label="Data tables">
      <div class="tabs__nav">
        <button id="tabReviews" class="tab tab--active" aria-controls="panelReviews" aria-selected="true">Reviews</button>
        <button id="tabQuick" class="tab hidden" aria-controls="panelQuick" aria-selected="false">Quick feedback</button>
      </div>

      <div id="panelReviews" class="tab-panel" role="tabpanel">
        <div class="table-wrap">
          <table class="table" id="reviewsTable">
            <thead>
              <tr>
                <th>Date</th><th>Kind</th><th>Review</th><th>Keywords</th><th>Visit</th><th>Parking</th><th>AI</th><th>Posted</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="reviewsBody"></tbody>
          </table>
          <div class="table__footer">
            <button id="loadMore" class="btn btn--ghost">Load more</button>
          </div>
        </div>
      </div>

      <div id="panelQuick" class="tab-panel hidden" role="tabpanel">
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>Date</th><th>Type</th><th>Meal</th><th>Spend</th><th>Feedback</th></tr></thead>
            <tbody id="quickBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <div class="foot">© <span id="year"></span> Your Company</div>
  </main>

  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ===== Helpers ===== */
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>[...r.querySelectorAll(s)];
    const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn);
    const toastBox=$('#toasts');
    const toast=(m,t='ok')=>{const el=document.createElement('div');el.className=`toast ${t==='ok'?'toast--ok':'toast--bad'}`;el.textContent=m;toastBox.appendChild(el);setTimeout(()=>el.remove(),3500)};

    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const escapeHtml=s=>String(s||'').replace(/[&<>"]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
    const csvEscape=s=>{const t=String(s??'');return /[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t};
    const darken=(hex,amt=.2)=>{const c=hex.replace('#','');const n=c.length===3?c.split('').map(x=>x+x).join(''):c;const r=parseInt(n.slice(0,2),16),g=parseInt(n.slice(2,4),16),b=parseInt(n.slice(4,6),16);const f=v=>clamp(Math.round(v*(1-amt)),0,255).toString(16).padStart(2,'0');return '#'+f(r)+f(g)+f(b)};
    const cssColor=x=>/^#|rgb|hsl/i.test(String(x))?x:'#22c55e';

    /* ===== State ===== */
    const state={
      slug:null, user:null, tenant:null,
      tzViewer: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
      tzChosen:'tenant', tzTenant:null,
      reviewsRaw:[], quickRaw:[],
      lastFetchLimit:300,
      filter:{ range:'30', kind:'all', posted:'all', ai:'all', visit:'all', parking:'all', search:'', kwSelected:new Set() }
    };

    /* ===== Identity ===== */
    function initIdentity(){
      if(!window.netlifyIdentity){ showLoggedOut(); return; }
      netlifyIdentity.on('init', u=>{ state.user=u; updateAuthUI(); u ? startIfReady() : showLoggedOut(); });
      netlifyIdentity.on('login', u=>{ state.user=u; updateAuthUI(); netlifyIdentity.close(); startIfReady(); });
      netlifyIdentity.on('logout', ()=>{ state.user=null; updateAuthUI(); showLoggedOut(); });
      netlifyIdentity.init();
    }
    function updateAuthUI(){
      const logged=!!state.user;
      $('#loginBtn').classList.toggle('hidden',logged);
      $('#userBox').classList.toggle('hidden',!logged);
      $('#whoami').textContent=logged?state.user.email:'—';
    }
    on($('#loginBtn'),'click',()=>netlifyIdentity?.open('login'));
    on($('#openLogin'),'click',()=>netlifyIdentity?.open('login'));
    on($('#logoutBtn'),'click',()=>netlifyIdentity?.logout());

    async function authedFetch(url,opts={}){
      if(!state.user) throw new Error('Not logged in');
      const token=await state.user.jwt(true);
      const res=await fetch(url,{
        ...opts,
        headers:{
          'Authorization':`Bearer ${token}`,
          'Content-Type':'application/json',
          ...(opts.headers||{})
        }
      });
      return res;
    }

    /* ===== Routing (get slug) ===== */
    function pickSlug(){
      const parts=location.pathname.replace(/^\/+|\/+$/g,'').split('/');
      // expect /owner/<slug>(/something?)
      if(parts[0]!=='owner' || !parts[1]) return null;
      return decodeURIComponent(parts[1]);
    }

    /* ===== Page flows ===== */
    function showLoggedOut(){
      $('#loginCard').classList.remove('hidden');
      $('#hero').classList.add('hidden');
      $('#filters').classList.add('hidden');
      $('#kpis').classList.add('hidden');
      $('#charts').classList.add('hidden');
      $('#keywordsCard').classList.add('hidden');
      $('#tables').classList.add('hidden');
    }

    async function startIfReady(){
      if(!state.user) return;
      state.slug = pickSlug();
      if(!state.slug){ toast('Missing slug in URL','bad'); return; }

      $('#year').textContent = new Date().getFullYear();

      // Load tenant meta
      await ensureTenantMeta();
      // Theme accent
      const accent = cssColor(state.tenant?.brand_color || '#22c55e');
      document.documentElement.style.setProperty('--accent', accent);
      document.documentElement.style.setProperty('--accent-2', darken(accent,.2));

      // Build top nav links (and brand home) after slug known
      $('.brand').setAttribute('href', `/owner/${encodeURIComponent(state.slug)}`);
      $('#tabSettings').href = `/owner/${encodeURIComponent(state.slug)}/settings`;
      $('#tabQR').href = `/owner/${encodeURIComponent(state.slug)}/qr`;

      // Header
      $('#title').textContent = state.tenant?.name || state.slug;
      $('#slugShow').textContent = state.slug;
      const pub = `${location.origin}/r/${state.slug}`;
      $('#publicLink').value = pub;
      $('#openPublic').href = pub;

      // QR
      await renderQR('#qrCanvas', pub, 180);

      // tz
      state.tzTenant = state.tenant?.timezone || null;
      loadTZPref(); applyTZNote();

      // Data
      await loadReviews({reset:true, limit:state.lastFetchLimit});
      await maybeLoadQuick();

      // Show sections
      $('#loginCard').classList.add('hidden');
      $('#hero').classList.remove('hidden');
      $('#filters').classList.remove('hidden');
      $('#kpis').classList.remove('hidden');
      $('#charts').classList.remove('hidden');
      $('#keywordsCard').classList.remove('hidden');
      $('#tables').classList.remove('hidden');

      // Render
      renderAll();
    }

    async function ensureTenantMeta(){
      try{
        // Try secure my-tenants first to get brand/timezone quickly
        const res = await authedFetch('/.netlify/functions/my-tenants');
        const j = await res.json();
        if(res.ok && j.ok){
          const hit = (j.tenants||[]).find(t=>t.slug===state.slug);
          if(hit){ state.tenant = hit; return; }
        }
      }catch(_){/* ignore */}
      try{
        const res = await fetch(`/.netlify/functions/get-tenant?slug=${encodeURIComponent(state.slug)}`,{cache:'no-store'});
        const j = await res.json();
        if(res.ok && j){ state.tenant = j.tenant || j; return; }
      }catch(_){/* ignore */}
      state.tenant = { slug: state.slug, name: state.slug, brand_color: '#22c55e' };
    }

    async function loadReviews({reset=false, limit=300}={}){
      try{
        const res = await authedFetch(`/.netlify/functions/reviews-owner?slug=${encodeURIComponent(state.slug)}&limit=${limit}`);
        const j = await res.json();
        if(res.ok && j.ok){
          const next = j.reviews || [];
          state.reviewsRaw = reset ? next : next; // API returns the first N; keep same behavior
          state.lastFetchLimit = limit;
        } else throw new Error(j.error || `HTTP ${res.status}`);
      }catch(e){ toast('Failed to load reviews: '+e.message,'bad'); }
    }
    async function maybeLoadQuick(){
      try{
        const res = await authedFetch(`/.netlify/functions/feedback-owner?slug=${encodeURIComponent(state.slug)}`);
        if(res.status===404){ $('#tabQuick').classList.add('hidden'); return; }
        const j = await res.json();
        if(res.ok && j.ok){ state.quickRaw = j.items || j.feedback || []; $('#tabQuick').classList.remove('hidden'); }
      }catch(_){ $('#tabQuick').classList.add('hidden'); }
    }

    /* ===== TZ ===== */
    function currentTZ(){ return state.tzChosen==='viewer' ? state.tzViewer : (state.tzTenant || state.tzViewer); }
    function applyTZNote(){ $('#tzNote').textContent = `All times in ${currentTZ()}`; $('#tzToggle').checked = (state.tzChosen==='viewer'); }
    function saveTZPref(){ try{ localStorage.setItem(`tzPref:${state.slug}`, state.tzChosen); }catch(_){ } }
    function loadTZPref(){ try{ const v = localStorage.getItem(`tzPref:${state.slug}`); if(v==='viewer'||v==='tenant') state.tzChosen=v; }catch(_){ } }

    on($('#tzToggle'),'change',e=>{ state.tzChosen = e.target.checked ? 'viewer':'tenant'; saveTZPref(); renderAll(); });

    /* ===== Filters UI ===== */
    on($('#dateRange'),'change',e=>{ state.filter.range=e.target.value; renderAll(); });
    on($('#kindFilter'),'change',e=>{ state.filter.kind=e.target.value; renderAll(); });
    on($('#postedFilter'),'change',e=>{ state.filter.posted=e.target.value; renderAll(); });
    on($('#aiFilter'),'change',e=>{ state.filter.ai=e.target.value; renderAll(); });
    on($('#visitFilter'),'change',e=>{ state.filter.visit=e.target.value; renderAll(); });
    on($('#parkingFilter'),'change',e=>{ state.filter.parking=e.target.value; renderAll(); });
    on($('#searchBox'),'input',e=>{ state.filter.search=e.target.value; renderAll(); });

    on($('#exportCsv'),'click',()=> {
      const rows=applyFilters();
      const tz=currentTZ();
      const fmt=new Intl.DateTimeFormat(undefined,{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      const headers=['Date','Kind','Review','Keywords','Visit','Parking','AI','Posted'];
      const csv=[headers.join(',')].concat(rows.map(r=>[
        csvEscape(fmt.format(new Date(r._ts))), csvEscape(r.kind||''), csvEscape(r.review_text||''),
        csvEscape((Array.isArray(r.keywords)?r.keywords:[]).join('; ')),
        csvEscape(r.visit_type||''), csvEscape(r.parking||''), csvEscape(r.ai_used?'Yes':''),
        csvEscape(r.posted_to_google?'Yes':'No')
      ].join(','))).join('\n');
      downloadFile(`reviews-${state.slug}.csv`,'text/csv',csv);
    });

    on($('#loadMore'),'click',async()=>{ await loadReviews({reset:false,limit:state.lastFetchLimit+300}); renderAll(); });

    /* ===== Copy/QR buttons ===== */
    on($('#copyLink'),'click',async()=>{ try{ await navigator.clipboard.writeText($('#publicLink').value); toast('Copied'); }catch{ toast('Copy failed','bad'); }});
    on($('#printQR'),'click',()=>window.print());
    on($('#downloadQR'),'click',()=>{ const c=$('#qrCanvas'); const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download=`qr-${state.slug}.png`; a.click(); });

    /* ===== Render ===== */
    function inRange(ts){
      const r=state.filter.range; if(r==='all') return true;
      const now=Date.now();
      const map={ '7':7, '30':30, '90':90 };
      const days = map[r]||30;
      return ts >= now - days*864e5;
    }

    function applyFilters(){
      const tz=currentTZ();
      const text=state.filter.search.trim().toLowerCase();
      const kwSel=state.filter.kwSelected;

      return state.reviewsRaw.filter(r=>{
        const t=new Date(r.created_at).getTime(); if(!inRange(t)) return false;
        if(state.filter.kind!=='all' && r.kind!==state.filter.kind) return false;
        if(state.filter.posted!=='all'){ const want=state.filter.posted==='yes'; if(!!r.posted_to_google!==want) return false; }
        if(state.filter.ai!=='all'){ const want=state.filter.ai==='yes'; if(!!r.ai_used!==want) return false; }
        if(state.filter.visit!=='all' && (r.visit_type||'')!==state.filter.visit) return false;
        if(state.filter.parking!=='all' && (r.parking||'')!==state.filter.parking) return false;
        if(kwSel.size){ const kws = Array.isArray(r.keywords)?r.keywords:[]; if(![...kwSel].every(k=>kws.includes(k))) return false; }
        if(text){
          const blob=[r.review_text||'',...(Array.isArray(r.keywords)?r.keywords:[]),r.visit_type||'',r.parking||''].join(' ').toLowerCase();
          if(!blob.includes(text)) return false;
        }
        return true;
      }).map(r=>({ ...r, _ts:new Date(r.created_at).getTime() }));
    }

    function renderAll(){
      applyTZNote();
      const rows=applyFilters();

      // KPIs
      const total=rows.length, exc=rows.filter(r=>r.kind==='excellent').length, good=rows.filter(r=>r.kind==='good').length, bad=rows.filter(r=>r.kind==='bad').length;
      const posted=rows.filter(r=>r.posted_to_google).length;
      $('#kpiTotal').textContent=total; $('#kpiExc').textContent=exc; $('#kpiGood').textContent=good; $('#kpiBad').textContent=bad;
      $('#kpiPosted').textContent = total ? Math.round((posted/total)*1000)/10 + '%' : '0%';

      // Keywords cloud
      const freq=new Map();
      rows.forEach(r=> (Array.isArray(r.keywords)?r.keywords:[]).forEach(k=>freq.set(k,(freq.get(k)||0)+1)));
      const top=[...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
      const cloud=$('#keywordsCloud'); cloud.innerHTML='';
      top.forEach(k=>{
        const chip=document.createElement('button'); chip.className='chip'; chip.type='button'; chip.textContent=k;
        const pressed=state.filter.kwSelected.has(k); chip.setAttribute('aria-pressed', pressed?'true':'false');
        chip.onclick=()=>{ if(pressed) state.filter.kwSelected.delete(k); else state.filter.kwSelected.add(k); renderAll(); };
        cloud.appendChild(chip);
      });
      on($('#keywordsReset'),'click',()=>{ state.filter.kwSelected.clear(); renderAll(); });

      // Charts
      renderTrend(rows); renderKind(rows);

      // Table
      renderTable(rows);

      // Feedback tab
      if(state.quickRaw.length){ $('#tabQuick').classList.remove('hidden'); renderQuick(); }
    }

    /* ===== Charts (SVG) ===== */
    function renderTrend(rows){
      const stage=$('#chartTrend'); stage.innerHTML='';
      const tz=currentTZ();
      const dayKey=ts=>{
        const d=new Date(ts);
        const f=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).format(d);
        return f; // yyyy-mm-dd
      };
      const map=new Map();
      rows.forEach(r=>{ const k=dayKey(r._ts); map.set(k,(map.get(k)||0)+1); });
      const data=[...map.entries()].sort((a,b)=>a[0].localeCompare(b[0])).map(([d,v])=>({d,v}));

      if(!data.length){ stage.textContent='No data yet'; return; }

      const W=640,H=220,P=26; const maxV=Math.max(1, ...data.map(x=>x.v));
      const svg=elt('svg',{viewBox:`0 0 ${W} ${H}`,width:'100%',height:'100%'});
      svg.appendChild(line(P,H-P,W-P,H-P,'#ffffff22')); svg.appendChild(line(P,P,P,H-P,'#ffffff22'));
      let d='M';
      data.forEach((x,i)=>{ const t=i/Math.max(1,data.length-1); const X=P+t*(W-2*P); const Y=H-P-(x.v/maxV)*(H-2*P); d+=`${X.toFixed(1)},${Y.toFixed(1)}${i===data.length-1?'':' L '}`; });
      const area=d+` L ${W-P},${H-P} L ${P},${H-P} Z`;
      const defs=elt('defs'); defs.appendChild(grad('g1','var(--accent)','transparent')); defs.appendChild(grad('g2','var(--accent)','var(--accent-2)')); svg.appendChild(defs);
      svg.appendChild(elt('path',{d:area,fill:'url(#g1)',opacity:'0.9'}));
      svg.appendChild(elt('path',{d,fill:'none',stroke:'url(#g2)','stroke-width':'2.5'}));
      stage.appendChild(svg);
    }
    function renderKind(rows){
      const stage=$('#chartKind'); stage.innerHTML='';
      const c={excellent:0,good:0,bad:0}; rows.forEach(r=>c[r.kind]=(c[r.kind]||0)+1);
      const items=Object.entries(c);
      const total = items.reduce((s,[,v])=>s+v,0);
      if(!total){ stage.textContent='No data yet'; return; }
      const W=360,H=220,P=26; const slot=(W-2*P)/items.length; const barW=slot-16; const maxV=Math.max(1,...items.map(([,v])=>v));
      const svg=elt('svg',{viewBox:`0 0 ${W} ${H}`,width:'100%',height:'100%'}); const defs=elt('defs'); defs.appendChild(grad('bar','var(--accent)','var(--accent-2)')); svg.appendChild(defs);
      items.forEach(([k,v],i)=>{ const x=P+i*slot+8; const h=(v/maxV)*(H-2*P); const y=H-P-h;
        svg.appendChild(elt('rect',{x,y,width:barW,height:h,fill:'url(#bar)'}));
        svg.appendChild(text(x+barW/2,H-P+16,k,'middle')); svg.appendChild(text(x+barW/2,y-6,v,'middle'));
      });
      stage.appendChild(svg);
    }
    function elt(tag,attrs={}){const e=document.createElementNS('http://www.w3.org/2000/svg',tag);Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v));return e}
    function grad(id,c1,c2){const g=elt('linearGradient',{id,x1:'0%',y1:'0%',x2:'0%',y2:'100%'});g.appendChild(elt('stop',{offset:'0%','stop-color':c1,'stop-opacity':'1'}));g.appendChild(elt('stop',{offset:'100%','stop-color':c2,'stop-opacity':'1'}));return g}
    function line(x1,y1,x2,y2,stroke){return elt('line',{x1,y1,x2,y2,stroke,'stroke-width':'1'})}
    function text(x,y,t,anchor='start'){const el=elt('text',{x,y,fill:'#dfe3f2','font-size':'11','text-anchor':anchor});el.textContent=t;return el}

    /* ===== Table ===== */
    function renderTable(rows){
      const tbody=$('#reviewsBody'); tbody.innerHTML='';
      const tz=currentTZ();
      const fmt=new Intl.DateTimeFormat(undefined,{timeZone:tz,year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      const rel=ms=>{const d=(Date.now()-ms)/1000; if(d<60) return 'now'; if(d<3600) return Math.floor(d/60)+'m'; if(d<86400) return Math.floor(d/3600)+'h'; return Math.floor(d/86400)+'d';};
      rows.sort((a,b)=>b._ts-a._ts).forEach(r=>{
        const tr=document.createElement('tr');
        const td=s=>{const e=document.createElement('td'); e.innerHTML=s; return e;};
        const kw=(Array.isArray(r.keywords)?r.keywords:[]).join(', ');
        const txt=r.review_text||'';
        tr.appendChild(td(`<span title="${fmt.format(new Date(r._ts))}">${rel(r._ts)}</span>`));
        tr.appendChild(td(escapeHtml(r.kind)));
        tr.appendChild(td(escapeHtml(txt.slice(0,160))+(txt.length>160?'…':'')));
        tr.appendChild(td(escapeHtml(kw)));
        tr.appendChild(td(escapeHtml(r.visit_type||'')));
        tr.appendChild(td(escapeHtml(r.parking||'')));
        tr.appendChild(td(r.ai_used?'Yes':''));
        tr.appendChild(td(r.posted_to_google?'Yes':'No'));
        const actions=document.createElement('td');
        const copyBtn=document.createElement('button'); copyBtn.className='btn btn--ghost'; copyBtn.type='button'; copyBtn.textContent='Copy';
        copyBtn.onclick=()=>navigator.clipboard.writeText(r.review_text||'').then(()=>toast('Copied')).catch(()=>toast('Copy failed','bad'));
        const gBtn=document.createElement('a'); gBtn.className='btn btn--ghost'; gBtn.textContent='Open Google';
        const g = state.tenant?.google_maps_url || state.tenant?.google?.mapsUrl || '';
        if(g){ gBtn.href=g; gBtn.target='_blank'; gBtn.rel='noopener'; } else { gBtn.href='#'; gBtn.addEventListener('click',e=>{ e.preventDefault(); toast('Google link not set','bad'); }); }
        actions.append(copyBtn,' ',gBtn);
        tr.appendChild(actions);
        tbody.appendChild(tr);
      });
    }

    function renderQuick(){
      const tbody=$('#quickBody'); tbody.innerHTML='';
      const tz=currentTZ(); const fmt=new Intl.DateTimeFormat(undefined,{timeZone:tz,year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      state.quickRaw.sort((a,b)=> new Date(b.timestampISO)-new Date(a.timestampISO)).forEach(q=>{
        const tr=document.createElement('tr');
        const td=s=>{const e=document.createElement('td'); e.textContent=s; return e;};
        tr.appendChild(td(fmt.format(new Date(q.timestampISO))));
        tr.appendChild(td(q?.answers?.type||'')); tr.appendChild(td(q?.answers?.meal||'')); tr.appendChild(td(q?.answers?.spend||'')); tr.appendChild(td(q?.answers?.text||''));
        tbody.appendChild(tr);
      });
    }

    function downloadFile(name,mime,content){
      const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    }

    /* ===== QR via remote PNG (simple) ===== */
    async function renderQR(sel,url,size){
      const c=$(sel); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
      const img=new Image(); img.crossOrigin='anonymous';
      img.src=`https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(url)}&size=${size}x${size}&margin=0`;
      await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; }).catch(()=>{});
      if(img.complete && img.naturalWidth){ ctx.drawImage(img,0,0,size,size); }
    }

    /* ===== Boot ===== */
    document.addEventListener('DOMContentLoaded',()=>{
      initIdentity();
      // Activate tabs within page (visual only)
      on($('#tabReviews'),'click',()=>{ $('#tabReviews').classList.add('tab--active'); $('#panelReviews').classList.remove('hidden'); $('#tabQuick').classList.remove('tab--active'); $('#panelQuick').classList.add('hidden'); });
      on($('#tabQuick'),'click',()=>{ $('#tabQuick').classList.add('tab--active'); $('#panelQuick').classList.remove('hidden'); $('#tabReviews').classList.remove('tab--active'); $('#panelReviews').classList.add('hidden'); });
    });
  </script>
</body>
</html>
